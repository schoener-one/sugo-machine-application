<!DOCTYPE html>
<html>
  <head>
    <title>SUGO Machine Control</title>
    <style type="text/css">
      body {
        background-color: #ffffff;
        color: #ee0000;
        margin: 0px;
      }
      .text-element {
        font-family: Arial, Helvetica, sans-serif;
        stroke: #333333;
        fill: #333333;
      }
      #user-control {
        display: flex;
        justify-content: center;
        margin: 0px;
      }
      .svg-button path:hover {
        fill: #cccccc;
      }
    </style>
    <script language="javascript" type="text/javascript">
      var currentLocation = window.location;
      var ws = null;
      var lastMachineState = "off";
      const colorActive = "#333333";
      const colorInactive = "#cccccc";
      const colorLightOn = "#aaff22";
      const colorLightOff = colorInactive;

      // Handle new machine state
      function receiveMachineState(js) {
        console.log("state: " + js.state);
        console.log("speed: " + js.speed);
        lastMachineState = js.state;
        document.getElementById("svg-speed-text").textContent = js.speed;
        updateUserControl();
      }

      // Request current machine state
      function requestMachineState() {
        console.log("requesting current machine state...");
        ws.send(
          JSON.stringify({
            type: "state-request",
          })
        );
      }

      function sendMachineCommand(commandName) {
        console.log("sending machine command '" + commandName + "'");
        ws.send(
          JSON.stringify({
            type: "command-request",
            command: commandName,
          })
        );
      }

      // Connect to websocket server
      function connect() {
        ws = new WebSocket("ws://" + currentLocation.host + "/websocket");
        ws.onopen = (event) => {
          console.log("...opened connection");
          requestMachineState();
        };

        ws.onclose = (event) => {
          console.log("closing connection...");
          setTimeout(function () {
            connect();
          }, 500);
        };

        ws.onmessage = (event) => {
          console.log("received message: '" + event.data + "'");
          var js = JSON.parse(event.data);
          if (js != null && "type" in js) {
            if (
              js.type == "state-response" ||
              js.type == "state-notification"
            ) {
              receiveMachineState(js);
            } else if (js.type == "command-response" && js.result == "nok") {
              alert("Command failed");
              console.log("command response: " + js.result);
            }
          }
        };

        ws.onerror = (error) => {
          console.log(error);
          ws.close();
          ws = null;
        };
      }

      // Update UI
      function updateUserControl() {
        var buttonStart = document.getElementById("svg-button-start-text");
        var buttonStop = document.getElementById("svg-button-stop-text");
        var buttonDec = document.getElementById(
          "svg-button-decrease-speed-triangle"
        );
        var buttonInc = document.getElementById(
          "svg-button-increase-speed-triangle"
        );
        var lightPower = document.getElementById("svg-light-power");
        var lightRunning = document.getElementById("svg-light-running");
        if (lastMachineState == "off") {
          buttonStart.style.stroke = colorActive;
          buttonStart.style.fill = colorActive;
          buttonStop.style.stroke = colorInactive;
          buttonStop.style.fill = colorInactive;
          buttonDec.style.fill = colorInactive;
          buttonInc.style.fill = colorInactive;
          lightPower.style.fill = colorLightOn;
          lightRunning.style.fill = colorLightOff;
        } else if (lastMachineState == "starting") {
          buttonStart.style.stroke = colorInactive;
          buttonStart.style.fill = colorInactive;
          buttonStop.style.stroke = colorInactive;
          buttonStop.style.fill = colorInactive;
          buttonDec.style.fill = colorActive;
          buttonInc.style.fill = colorActive;
          lightPower.style.fill = colorLightOn;
          lightRunning.style.fill = colorLightOff;
        } else if (lastMachineState == "running") {
          buttonStart.style.stroke = colorInactive;
          buttonStart.style.fill = colorInactive;
          buttonStop.style.stroke = colorActive;
          buttonStop.style.fill = colorActive;
          buttonDec.style.fill = colorActive;
          buttonInc.style.fill = colorActive;
          lightPower.style.fill = colorLightOn;
          lightRunning.style.fill = colorLightOn;
        }
        updateEventHandlers();
      }

      function updateEventHandlers() {
        if (lastMachineState == "off") {
          document.getElementById("svg-button-start").onclick = function () {
            sendMachineCommand("start");
          };
          document.getElementById("svg-button-stop").onclick = null;
          document.getElementById("svg-button-increase-speed").onclick = null;
          document.getElementById("svg-button-decrease-speed").onclick = null;
        } else if (lastMachineState == "starting") {
          document.getElementById("svg-button-start").onclick = null;
          document.getElementById("svg-button-stop").onclick = null;
          document.getElementById("svg-button-increase-speed").onclick = null;
          document.getElementById("svg-button-decrease-speed").onclick = null;
        } else if (lastMachineState == "running") {
          document.getElementById("svg-button-start").onclick = null;
          document.getElementById("svg-button-stop").onclick = function () {
            sendMachineCommand("stop");
          };
          document.getElementById("svg-button-increase-speed").onclick =
            function () {
              sendMachineCommand("increase-speed");
            };
          document.getElementById("svg-button-decrease-speed").onclick =
            function () {
              sendMachineCommand("decrease-speed");
            };
        }
      }
      window.onload = function () {
        updateUserControl();
        connect();
      };
    </script>
  </head>
  <body>
    <div id="user-control">
      <svg
        version="1.2"
        baseProfile="tiny"
        id="svg-user-control"
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        width="1024px"
        height="768px"
        viewBox="0 0 1024 768"
        xml:space="preserve"
        preserveAspectRatio="xMidYMin slice"
      >
        <g>
          <g class="svg-button" id="svg-button-start">
            <path
              fill="none"
              stroke="#CCCCCC"
              stroke-width="6"
              stroke-miterlimit="10"
              d="M297,240.295c0,6.627-4.521,11.705-10.715,11.705
			h-177.57C102.521,252,97,246.922,97,240.295v-56c0-6.627,5.521-12.295,11.715-12.295h177.57c6.194,0,10.715,5.667,10.715,12.295
			V240.295z"
            />

            <text
              transform="matrix(0.9346 0 0 1 159.1729 220.9609)"
              stroke="#333333"
              stroke-miterlimit="10"
              class="text-element"
              font-size="36"
              id="svg-button-start-text"
            >
              start
            </text>
          </g>
          <g class="svg-button" id="svg-button-stop">
            <path
              fill="none"
              stroke="#CCCCCC"
              stroke-width="6"
              stroke-miterlimit="10"
              d="M551,240.295c0,6.627-4.521,11.705-10.715,11.705
			h-177.57c-6.194,0-11.715-5.078-11.715-11.705v-56c0-6.627,5.521-12.295,11.715-12.295h177.57c6.193,0,10.715,5.667,10.715,12.295
			V240.295z"
            />

            <text
              transform="matrix(0.9346 0 0 1 413.1729 220.9609)"
              stroke="#f33333"
              stroke-miterlimit="10"
              class="text-element"
              font-size="36"
              id="svg-button-stop-text"
            >
              stop
            </text>
          </g>
          <g>
            <path
              fill="none"
              stroke="#CCCCCC"
              stroke-width="6"
              stroke-miterlimit="10"
              d="M431,425c0,6.627-5.373,12-12,12H229
			c-6.627,0-12-5.373-12-12v-56c0-6.627,5.373-12,12-12h190c6.627,0,12,5.373,12,12V425z"
            />

            <text
              transform="matrix(1 0 0 1 274.4673 405.9609)"
              stroke="#333333"
              stroke-miterlimit="10"
              class="text-element"
              font-size="36"
              id="svg-speed-text"
            >
              0
            </text>

            <text
              transform="matrix(1 0 0 1 344.5337 405.9609)"
              stroke="#333333"
              stroke-miterlimit="10"
              class="text-element"
              font-size="18"
            >
              rpm
            </text>
          </g>
          <g class="svg-button" id="svg-button-increase-speed">
            <path
              fill="none"
              stroke="#CCCCCC"
              stroke-width="6"
              stroke-miterlimit="10"
              d="M551,424.322c0,7.164-4.569,12.678-10.82,12.678
			h-77.359c-6.252,0-11.821-5.514-11.821-12.678v-54.054c0-7.165,5.568-13.268,11.821-13.268h77.359
			c6.251,0,10.82,6.103,10.82,13.268V424.322z"
            />
            <polygon
              fill="#333333"
              id="svg-button-decrease-speed-triangle"
              points="483,370.795 483,423.795 518.942,397.295 		"
            />
          </g>
          <g class="svg-button" id="svg-button-decrease-speed">
            <path
              fill="none"
              stroke="#CCCCCC"
              stroke-width="6"
              stroke-miterlimit="10"
              d="M97,370.268c0-7.164,5.569-13.268,11.82-13.268
			h77.359c6.252,0,10.82,6.104,10.82,13.268v54.055c0,7.164-4.568,12.678-10.82,12.678H108.82c-6.251,0-11.82-5.514-11.82-12.678
			V370.268z"
            />
            <polygon
              fill="#333333"
              id="svg-button-increase-speed-triangle"
              points="165,423.795 165,370.795 129.058,397.295 		"
            />
          </g>
          <g>
            <g>
              <path
                fill="none"
                d="M847,402.795c0,6.627-5.023,12.205-11.836,12.205H639.836c-6.813,0-12.836-5.578-12.836-12.205v-56
				c0-6.627,6.023-11.795,12.836-11.795h195.328c6.813,0,11.836,5.167,11.836,11.795V402.795z"
              />
              <g>
                <circle
                  id="svg-light-running"
                  fill="#00C846"
                  stroke="#333333"
                  cx="656.5"
                  cy="375.5"
                  r="25"
                />
                <g>
                  <polygon
                    points="650.64,359.017 641.086,361.109 644.502,364.76 647.854,368.341 					"
                  />
                  <path
                    d="M667.415,361.449l-2.661,3.002c2.872,2.396,4.715,5.989,4.715,10.014c0,7.198-5.856,13.055-13.055,13.055
						c-7.197,0-13.054-5.885-13.054-13.083c0-3.7,1.557-7.437,4.04-9.437H646v-3.684c-4,3.128-6.433,7.856-6.433,13.148
						c0,9.404,7.547,17.055,16.95,17.055c9.404,0,17.003-7.65,17.003-17.055C673.521,369.251,671.114,364.579,667.415,361.449z"
                  />
                </g>
              </g>

              <text
                transform="matrix(0.9346 0 0 1 709.1729 383.4609)"
                stroke="#333333"
                stroke-miterlimit="10"
                class="text-element"
                font-size="36"
              >
                running
              </text>
            </g>
            <g>
              <path
                fill="none"
                d="M847,303.295c0,6.627-5.023,11.705-11.836,11.705H639.836c-6.813,0-12.836-5.078-12.836-11.705v-56
				c0-6.627,6.023-12.295,12.836-12.295h195.328c6.813,0,11.836,5.667,11.836,12.295V303.295z"
              />
              <g>
                <circle
                  id="svg-light-power"
                  fill="#CC3300"
                  stroke="#333333"
                  cx="656.5"
                  cy="275.5"
                  r="25"
                />
                <g>
                  <g>
                    <path
                      d="M665,261.214v4.799c3,2.395,4.719,6.059,4.719,10.164c0,7.198-5.938,13.055-13.137,13.055
							s-12.931-5.856-12.931-13.055c0-4.693,2.349-8.804,6.349-11.104v-4.512c-6,2.639-10.39,8.642-10.39,15.616
							c0,9.404,7.568,17.055,16.972,17.055c9.404,0,17.178-7.65,17.178-17.055C673.76,269.732,670,264.114,665,261.214z"
                    />
                    <rect x="655" y="258" width="5" height="20" />
                  </g>
                </g>
              </g>

              <text
                transform="matrix(0.9346 0 0 1 709.1729 283.9609)"
                stroke="#333333"
                stroke-miterlimit="10"
                class="text-element"
                font-size="36"
              >
                power
              </text>
            </g>
            <g>
              <g>
                <path
                  fill="none"
                  stroke="#CCCCCC"
                  stroke-width="6"
                  stroke-miterlimit="10"
                  d="M856.814,168H724.5c0,5-5.82,9-13,9h-57.416
					c-7.181,0-13-4-13-9h-22.899c-5.901,0-11.185,4.769-11.185,9.881v252.234c0,5.111,5.284,8.885,11.185,8.885h238.629
					c5.901,0,10.186-3.773,10.186-8.885V177.881C867,172.769,862.716,168,856.814,168z"
                />
              </g>
              <text
                transform="matrix(0.9346 0 0 1 654.0127 168.2949)"
                class="text-element"
                font-size="24"
              >
                State
              </text>
            </g>
          </g>
        </g>
        <path
          fill="none"
          stroke="#CCCCCC"
          stroke-width="10"
          stroke-miterlimit="10"
          d="M902,463c0,6.627-5.373,12-12,12H75
	c-6.627,0-12-5.373-12-12V124c0-6.627,5.373-12,12-12h815c6.627,0,12,5.373,12,12V463z"
        />
      </svg>
    </div>
    <p id="state-text">State</p>
  </body>
</html>
